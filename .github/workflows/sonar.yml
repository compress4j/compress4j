name: Sonar
on:
  workflow_dispatch:
    inputs:
      runId:
        description: 'Run ID'
        required: true
      eventName:
        description: 'Event type'
        required: true
        default: 'workflow_dispatch'
      prNumber:
        description: 'Pull Request number'
        required: false
      baseRef:
        description: 'Base git reference'
        required: false
      headRef:
        description: 'Head git reference'
        required: false
      jdk_version:
        description: 'JDK version'
        required: true
        default: 21

permissions:
  contents: read
  actions: write

jobs:
  sonar:
    name: Sonar
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
          ref: ${{github.event.workflow_run.head_sha}}
      - name: "Set up JDK ${{ github.event.inputs.jdk_version }}"
        uses: actions/setup-java@v5
        with:
          java-version: ${{ github.event.inputs.jdk_version }}
          distribution: 'temurin'
          cache: 'gradle'
      - name: "Download JDK ${{ github.event.inputs.jdk_version }} Test reports"
        uses: actions/download-artifact@v6
        with:
          path: reports
          pattern: "ubuntu-latest-jdk_${{ github.event.inputs.jdk_version }}-test-reports"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.inputs.runId }}
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: "ubuntu-latest-jdk_${{ github.event.inputs.jdk_version }}-sonar"
          restore-keys: "ubuntu-latest-jdk_${{ github.event.inputs.jdk_version }}-sonar"
      - name: Create coverage report and run Sonar analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mkdir build
          cp -r reports/*-reports/* build/
          
          if [ '${{github.event.inputs.eventName}}' == 'pull_request' ]; then
            ./gradlew jacocoTestReport sonar \
              -Dsonar.pullrequest.base=${{github.event.inputs.baseRef}} \
              -Dsonar.pullrequest.branch=${{github.event.inputs.headRef}} \
              -Dsonar.pullrequest.key=${{github.event.inputs.prNumber}} \
              -Dsonar.pullrequest.provider=GitHub \
              -Dsonar.pullrequest.github.repository=${{github.repository}}
          else
            ./gradlew jacocoTestReport sonar --info
          fi
        shell: bash
      - name: Trigger release when a tag is pushed
        if: startsWith( github.ref, 'refs/tags' )
        run: |
          echo Trigger release on a tag
          gh workflow run \
            --ref ${{ github.ref_name }} release.yml \
            -f jdk_version=${{ github.event.inputs.jdk_version }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
